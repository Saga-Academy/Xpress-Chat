<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>Galactic Comm-Link</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Rajdhani:wght@500&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
  :root {
    /* Light Side (Jedi) - default */
    --bg-primary: #0a192f;
    --bg-secondary: #112240;
    --text-primary: #e6f1ff;
    --text-secondary: #8892b0;
    --accent: #00aaff;
    --jedi-blue: #00aaff;
    --sith-red: #ff2222;
    --header-bg: rgba(10, 25, 47, 0.95);
    --input-bg: #112240;
    --message-bg: #1a3a5f;
    --own-message-bg: #00aaff;
    --scrollbar-thumb: #00aaff;
    --success: #00ff88;
    --warning: #ffaa00;
    --error: #ff4444;
  }

  [data-theme="dark"] {
    /* Dark Side (Sith) */
    --bg-primary: #0d0d0d;
    --bg-secondary: #1a1a1a;
    --text-primary: #ffcccc;
    --text-secondary: #ff8888;
    --accent: #ff0000;
    --jedi-blue: #4466aa;
    --sith-red: #ff4444;
    --header-bg: rgba(20, 0, 0, 0.95);
    --input-bg: #2a1a1a;
    --message-bg: #331111;
    --own-message-bg: #ff0000;
    --scrollbar-thumb: #ff0000;
    --success: #ff4444;
    --warning: #ff8800;
    --error: #ff2222;
  }

  * {
    box-sizing: border-box;
  }

  body {
    margin: 0;
    padding: 0;
    font-family: 'Rajdhani', sans-serif;
    background: var(--bg-primary);
    color: var(--text-primary);
    height: 100vh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    transition: all 0.5s ease;
  }

  /* Starfield Background */
  .starfield {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: -1;
    overflow: hidden;
  }

  .star {
    position: absolute;
    background-color: white;
    border-radius: 50%;
  }

  /* Header Styles */
  #chatHeader {
    background: var(--header-bg);
    backdrop-filter: blur(15px);
    padding: 15px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 1.1rem;
    border-bottom: 2px solid var(--accent);
    flex-shrink: 0;
    flex-wrap: wrap;
    gap: 15px;
    z-index: 100;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
  }

  .sector-info {
    display: flex;
    align-items: center;
    gap: 15px;
  }

  .sector-title {
    font-family: 'Orbitron', sans-serif;
    color: var(--accent);
    letter-spacing: 1.5px;
    text-transform: uppercase;
    font-size: 1.1rem;
    text-shadow: 0 0 10px currentColor;
  }

  #roomName {
    color: var(--text-primary);
    background: rgba(0, 0, 0, 0.3);
    padding: 4px 10px;
    border-radius: 4px;
    border: 1px solid var(--accent);
  }

  .user-info {
    display: flex;
    align-items: center;
    gap: 15px;
  }

  .user-avatar-container {
    position: relative;
    cursor: pointer;
    transition: transform 0.3s;
  }

  .user-avatar-container:hover {
    transform: scale(1.1);
  }

  .user-avatar {
    width: 45px;
    height: 45px;
    border-radius: 50%;
    border: 2px solid var(--accent);
    object-fit: cover;
    box-shadow: 0 0 15px rgba(0, 170, 255, 0.3);
  }

  [data-theme="dark"] .user-avatar {
    border-color: #ff4444;
    box-shadow: 0 0 15px rgba(255, 0, 0, 0.3);
  }

  .user-avatar-container::after {
    content: 'âœŽ';
    position: absolute;
    bottom: -5px;
    right: -5px;
    background: var(--accent);
    color: white;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 10px;
    opacity: 0;
    transition: opacity 0.3s;
  }

  .user-avatar-container:hover::after {
    opacity: 1;
  }

  .user-details {
    display: flex;
    flex-direction: column;
  }

  .user-name {
    font-weight: bold;
    font-size: 1rem;
    color: var(--text-primary);
  }

  .user-status {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 0.8rem;
    color: var(--text-secondary);
  }

  .status-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #4CAF50;
    animation: pulse 2s infinite;
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.5; transform: scale(0.9); }
  }

  .theme-controls {
    display: flex;
    gap: 10px;
  }

  .theme-controls button {
    padding: 8px 16px;
    border: none;
    border-radius: 6px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s;
    font-family: 'Orbitron', sans-serif;
    letter-spacing: 1px;
    font-size: 0.9rem;
    display: flex;
    align-items: center;
    gap: 6px;
    min-width: 100px;
    justify-content: center;
  }

  .theme-controls button:nth-child(1) { /* JEDI */
    background: linear-gradient(135deg, var(--jedi-blue), #0066cc);
    color: white;
  }

  .theme-controls button:nth-child(2) { /* SITH */
    background: linear-gradient(135deg, var(--sith-red), #cc0000);
    color: white;
  }

  .theme-controls button:nth-child(3) { /* LEAVE */
    background: linear-gradient(135deg, #ff4444, #cc0000);
    color: white;
  }

  .theme-controls button:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4);
    filter: brightness(1.1);
  }

  .theme-controls button:active {
    transform: translateY(0);
  }

  /* Messages Container */
  #messages {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
    display: flex;
    flex-direction: column;
    gap: 15px;
    background: transparent;
  }

  /* Scrollbar Styling */
  #messages::-webkit-scrollbar {
    width: 10px;
  }

  #messages::-webkit-scrollbar-track {
    background: rgba(0, 0, 0, 0.2);
    border-radius: 5px;
  }

  #messages::-webkit-scrollbar-thumb {
    background: var(--scrollbar-thumb);
    border-radius: 5px;
    border: 2px solid transparent;
    background-clip: padding-box;
  }

  #messages::-webkit-scrollbar-thumb:hover {
    background: var(--accent);
    filter: brightness(1.2);
  }

  /* Message Styles */
  .message {
    max-width: 75%;
    padding: 15px 20px;
    border-radius: 20px;
    line-height: 1.5;
    word-wrap: break-word;
    align-self: flex-start;
    background: var(--message-bg);
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
    border: 1px solid rgba(255, 255, 255, 0.1);
    animation: messageAppear 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    position: relative;
    overflow: hidden;
  }

  .message::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 2px;
    background: linear-gradient(90deg, transparent, var(--accent), transparent);
  }

  @keyframes messageAppear {
    from {
      opacity: 0;
      transform: translateY(20px) scale(0.95);
    }
    to {
      opacity: 1;
      transform: translateY(0) scale(1);
    }
  }

  .message.own {
    align-self: flex-end;
    background: var(--own-message-bg);
    color: white;
    border: none;
  }

  .message.own::before {
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
  }

  .message.system {
    align-self: center;
    max-width: 85%;
    background: rgba(0, 0, 0, 0.3);
    color: var(--text-secondary);
    font-style: italic;
    font-size: 0.9rem;
    text-align: center;
    border: 1px dashed var(--accent);
  }

  .message .message-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 8px;
  }

  .message-avatar {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    border: 2px solid var(--accent);
    object-fit: cover;
  }

  .message .sender {
    font-weight: bold;
    font-size: 0.95rem;
    opacity: 0.9;
  }

  .message .text {
    font-size: 1.05rem;
    line-height: 1.6;
    margin: 10px 0;
  }

  .message .time {
    font-size: 0.75rem;
    opacity: 0.7;
    text-align: right;
    margin-top: 8px;
    color: inherit;
  }

  .message.own .time {
    color: rgba(255, 255, 255, 0.8);
  }

  /* Typing Indicator */
  .typing-indicator {
    padding: 12px 20px;
    margin: 0 20px 10px 20px;
    display: none;
    align-items: center;
    gap: 12px;
    background: rgba(0, 0, 0, 0.2);
    border-radius: 15px;
    border: 1px solid rgba(255, 255, 255, 0.1);
  }

  .typing-dots {
    display: flex;
    gap: 5px;
  }

  .typing-dots span {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: var(--accent);
    animation: typing 1.4s infinite;
  }

  .typing-dots span:nth-child(2) {
    animation-delay: 0.2s;
  }

  .typing-dots span:nth-child(3) {
    animation-delay: 0.4s;
  }

  @keyframes typing {
    0%, 60%, 100% {
      transform: translateY(0);
      opacity: 0.3;
    }
    30% {
      transform: translateY(-6px);
      opacity: 1;
    }
  }

  /* Input Bar */
  .inputBar {
    display: flex;
    padding: 20px;
    background: var(--header-bg);
    backdrop-filter: blur(15px);
    border-top: 2px solid var(--accent);
    flex-shrink: 0;
    gap: 15px;
    box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.3);
  }

  #msg {
    flex: 1;
    padding: 15px 20px;
    border: 2px solid var(--accent);
    border-radius: 30px;
    background: var(--input-bg);
    color: var(--text-primary);
    font-size: 1.1rem;
    font-family: 'Rajdhani', sans-serif;
    transition: all 0.3s;
    min-height: 50px;
    resize: none;
  }

  #msg:focus {
    outline: none;
    box-shadow: 0 0 20px var(--accent);
    transform: scale(1.01);
  }

  #msg::placeholder {
    color: var(--text-secondary);
    opacity: 0.7;
  }

  .inputBar button {
    padding: 0 30px;
    border: none;
    border-radius: 30px;
    background: var(--accent);
    color: white;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s;
    font-family: 'Orbitron', sans-serif;
    letter-spacing: 1px;
    min-width: 120px;
    font-size: 1rem;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
  }

  .inputBar button:hover:not(:disabled) {
    background: var(--sith-red);
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(255, 0, 0, 0.3);
  }

  .inputBar button:active:not(:disabled) {
    transform: translateY(0);
  }

  .inputBar button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none !important;
  }

  /* Empty State */
  .empty-state {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
    padding: 40px 20px;
    color: var(--text-secondary);
    animation: fadeIn 1s ease-out;
  }

  .empty-state h3 {
    font-family: 'Orbitron', sans-serif;
    margin-bottom: 15px;
    color: var(--accent);
    font-size: 1.5rem;
    text-shadow: 0 0 10px currentColor;
  }

  .empty-state p {
    max-width: 400px;
    line-height: 1.6;
    font-size: 1.1rem;
  }

  .empty-state .icon {
    font-size: 4rem;
    margin-bottom: 20px;
    opacity: 0.5;
  }

  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }

  /* Notification */
  .notification {
    position: fixed;
    top: 90px;
    right: 20px;
    padding: 15px 25px;
    background: var(--header-bg);
    border: 2px solid var(--accent);
    border-radius: 10px;
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
    z-index: 1000;
    animation: slideIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    display: none;
    backdrop-filter: blur(10px);
    max-width: 350px;
  }

  @keyframes slideIn {
    from {
      transform: translateX(100%);
      opacity: 0;
    }
    to {
      transform: translateX(0);
      opacity: 1;
    }
  }

  /* Loading Animation */
  .loading {
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    height: 100%;
    gap: 20px;
  }

  .spinner {
    width: 60px;
    height: 60px;
    border: 4px solid rgba(255, 255, 255, 0.1);
    border-radius: 50%;
    border-top-color: var(--accent);
    animation: spin 1.2s ease-in-out infinite;
  }

  .loading-text {
    color: var(--text-secondary);
    font-family: 'Orbitron', sans-serif;
    letter-spacing: 2px;
    animation: pulseText 2s infinite;
  }

  @keyframes pulseText {
    0%, 100% { opacity: 0.5; }
    50% { opacity: 1; }
  }

  /* Mobile Responsiveness */
  @media (max-width: 1024px) {
    .message {
      max-width: 85%;
    }
  }

  @media (max-width: 768px) {
    #chatHeader {
      padding: 12px 15px;
      gap: 12px;
    }

    .sector-info {
      flex: 1;
      justify-content: space-between;
    }

    .theme-controls {
      order: 3;
      width: 100%;
      justify-content: center;
    }

    .theme-controls button {
      min-width: 90px;
      padding: 8px 12px;
      font-size: 0.85rem;
    }

    .user-details {
      display: none;
    }

    .user-avatar {
      width: 40px;
      height: 40px;
    }

    #messages {
      padding: 15px;
    }

    .message {
      max-width: 90%;
      padding: 12px 16px;
    }

    .inputBar {
      padding: 15px;
      gap: 10px;
    }

    #msg {
      padding: 12px 16px;
      min-height: 45px;
    }

    .inputBar button {
      padding: 0 20px;
      min-width: 100px;
    }
  }

  @media (max-width: 480px) {
    #chatHeader {
      flex-direction: column;
      text-align: center;
    }

    .sector-info {
      width: 100%;
    }

    .user-info {
      width: 100%;
      justify-content: center;
    }

    .theme-controls {
      width: 100%;
    }

    .theme-controls button {
      flex: 1;
    }

    .message {
      max-width: 95%;
    }

    .inputBar {
      flex-direction: column;
    }

    .inputBar button {
      width: 100%;
      padding: 12px;
    }
  }

  /* Avatar Modal */
  .avatar-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.9);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 2000;
    backdrop-filter: blur(10px);
  }

  .avatar-modal-content {
    background: var(--header-bg);
    border: 3px solid var(--accent);
    border-radius: 15px;
    padding: 30px;
    max-width: 500px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
  }

  .avatar-modal h3 {
    color: var(--accent);
    text-align: center;
    margin-bottom: 20px;
    font-family: 'Orbitron', sans-serif;
  }

  .avatar-options {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 15px;
    margin-bottom: 20px;
  }

  .avatar-option {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    cursor: pointer;
    transition: all 0.3s;
    border: 2px solid transparent;
    object-fit: cover;
  }

  .avatar-option:hover {
    transform: scale(1.1);
    border-color: var(--accent);
  }

  .avatar-option.selected {
    border-color: var(--accent);
    box-shadow: 0 0 20px var(--accent);
  }

  .avatar-custom-input {
    display: flex;
    gap: 10px;
    margin-top: 20px;
  }

  .avatar-custom-input input {
    flex: 1;
    padding: 12px;
    background: var(--input-bg);
    border: 2px solid var(--accent);
    border-radius: 8px;
    color: var(--text-primary);
  }

  .avatar-custom-input button {
    padding: 12px 20px;
    background: var(--accent);
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: bold;
  }
</style>
</head>
<body data-theme="light">

<!-- Starfield Background -->
<div class="starfield" id="starfield"></div>

<!-- Avatar Modal -->
<div class="avatar-modal" id="avatarModal">
  <div class="avatar-modal-content">
    <h3><i class="fas fa-user-astronaut"></i> CHANGE YOUR AVATAR</h3>
    
    <div class="avatar-options" id="avatarOptions">
      <!-- Avatars will be loaded here -->
    </div>
    
    <div class="avatar-custom-input">
      <input type="url" id="customAvatarUrl" placeholder="Or enter custom image URL">
      <button onclick="useCustomAvatar()">Use URL</button>
    </div>
    
    <div style="text-align: center; margin-top: 20px;">
      <button onclick="closeAvatarModal()" style="background: var(--sith-red); color: white; border: none; padding: 10px 30px; border-radius: 8px; cursor: pointer;">
        Cancel
      </button>
      <button onclick="saveAvatar()" style="background: var(--jedi-blue); color: white; border: none; padding: 10px 30px; border-radius: 8px; cursor: pointer; margin-left: 10px;">
        Save Avatar
      </button>
    </div>
  </div>
</div>

<!-- Notification -->
<div id="notification" class="notification"></div>

<!-- Main Chat Header -->
<div id="chatHeader">
  <div class="sector-info">
    <div class="sector-title">
      <i class="fas fa-satellite"></i> SECTOR: 
      <span id="roomName">CORUSCANT CENTRAL</span>
    </div>
  </div>

  <div class="theme-controls">
    <button onclick="switchSide('light')" title="Switch to Jedi Theme">
      <i class="fas fa-sun"></i> JEDI
    </button>
    <button onclick="switchSide('dark')" title="Switch to Sith Theme">
      <i class="fas fa-moon"></i> SITH
    </button>
    <button onclick="logout()" title="Leave Chat">
      <i class="fas fa-sign-out-alt"></i> LEAVE
    </button>
  </div>

  <div class="user-info">
    <div class="user-avatar-container" onclick="openAvatarModal()" title="Click to change avatar">
      <img id="userAvatar" class="user-avatar" src="" alt="Your Avatar">
    </div>
    <div class="user-details">
      <div class="user-name" id="userName">Loading...</div>
      <div class="user-status">
        <span class="status-dot"></span>
        <span id="onlineCount">Connecting...</span>
      </div>
    </div>
  </div>
</div>

<!-- Messages Container -->
<div id="messages">
  <div class="loading">
    <div class="spinner"></div>
    <div class="loading-text">INITIALIZING COMMUNICATION LINK...</div>
  </div>
</div>

<!-- Typing Indicator -->
<div class="typing-indicator" id="typingIndicator">
  <div class="typing-dots">
    <span></span>
    <span></span>
    <span></span>
  </div>
  <span id="typingUser">Someone is typing...</span>
</div>

<!-- Input Area -->
<div class="inputBar">
  <textarea id="msg" placeholder="Transmit your message through the holonet..." 
            rows="1" autocomplete="off" oninput="autoResize(this)"></textarea>
  <button onclick="sendMessage()" id="sendButton">
    <i class="fas fa-paper-plane"></i> TRANSMIT
  </button>
</div>

<script>
  // Starfield creation
  function createStarfield() {
    const starfield = document.getElementById('starfield');
    const starCount = 200;
    
    for (let i = 0; i < starCount; i++) {
      const star = document.createElement('div');
      star.className = 'star';
      
      const size = Math.random() * 3 + 1;
      const x = Math.random() * 100;
      const y = Math.random() * 100;
      const opacity = Math.random() * 0.8 + 0.2;
      const duration = Math.random() * 10 + 5;
      const delay = Math.random() * 5;
      
      star.style.width = `${size}px`;
      star.style.height = `${size}px`;
      star.style.left = `${x}%`;
      star.style.top = `${y}%`;
      star.style.opacity = opacity;
      star.style.animation = `twinkle ${duration}s infinite ${delay}s`;
      
      starfield.appendChild(star);
    }
    
    // Add twinkle animation
    const style = document.createElement('style');
    style.textContent = `
      @keyframes twinkle {
        0%, 100% { opacity: 0.2; }
        50% { opacity: 1; }
      }
    `;
    document.head.appendChild(style);
  }

  // Avatar gallery data
  const AVATAR_GALLERY = [
    // Jedi/Sith
    { id: 'jedi1', url: 'https://api.dicebear.com/7.x/avataaars/svg?seed=jedi1&backgroundColor=00aaff&hair=long', name: 'Jedi Master' },
    { id: 'jedi2', url: 'https://api.dicebear.com/7.x/avataaars/svg?seed=jedi2&backgroundColor=4a90e2&hair=short', name: 'Jedi Knight' },
    { id: 'sith1', url: 'https://api.dicebear.com/7.x/avataaars/svg?seed=sith1&backgroundColor=ff4444&accessories=sunglasses', name: 'Sith Lord' },
    { id: 'sith2', url: 'https://api.dicebear.com/7.x/avataaars/svg?seed=sith2&backgroundColor=ff2222&hair=short', name: 'Sith Apprentice' },
    
    // Rebels/Imperials
    { id: 'rebel1', url: 'https://api.dicebear.com/7.x/avataaars/svg?seed=rebel1&backgroundColor=333333&hair=short', name: 'Rebel Pilot' },
    { id: 'imperial1', url: 'https://api.dicebear.com/7.x/avataaars/svg?seed=imperial1&backgroundColor=666666&hair=short', name: 'Imperial Officer' },
    { id: 'smuggler', url: 'https://api.dicebear.com/7.x/avataaars/svg?seed=smuggler&backgroundColor=8B4513&facialHair=beard', name: 'Smuggler' },
    { id: 'bounty', url: 'https://api.dicebear.com/7.x/avataaars/svg?seed=bounty&backgroundColor=000000&accessories=eyepatch', name: 'Bounty Hunter' },
    
    // Droids
    { id: 'r2d2', url: 'https://api.dicebear.com/7.x/bots/svg?seed=r2d2', name: 'R2-D2' },
    { id: 'c3po', url: 'https://api.dicebear.com/7.x/bots/svg?seed=c3po', name: 'C-3PO' },
    { id: 'bb8', url: 'https://api.dicebear.com/7.x/bots/svg?seed=bb8', name: 'BB-8' },
    { id: 'droid1', url: 'https://api.dicebear.com/7.x/bots/svg?seed=droid1', name: 'Battle Droid' },
    
    // Aliens
    { id: 'yoda', url: 'https://api.dicebear.com/7.x/avataaars/svg?seed=yoda&backgroundColor=00ff88&skinColor=f9d9ab', name: 'Yoda Species' },
    { id: 'wookie', url: 'https://api.dicebear.com/7.x/avataaars/svg?seed=wookie&backgroundColor=8B4513&hair=long', name: 'Wookiee' },
    { id: 'twilek', url: 'https://api.dicebear.com/7.x/avataaars/svg?seed=twilek&backgroundColor=ff00ff&hair=long', name: 'Twi\'lek' },
    { id: 'rodian', url: 'https://api.dicebear.com/7.x/avataaars/svg?seed=rodian&backgroundColor=00ff00', name: 'Rodian' },
    
    // Sci-Fi
    { id: 'cyborg', url: 'https://api.dicebear.com/7.x/avataaars/svg?seed=cyborg&backgroundColor=00aaff&accessories=glasses', name: 'Cyborg' },
    { id: 'android', url: 'https://api.dicebear.com/7.x/bots/svg?seed=android', name: 'Android' },
    { id: 'hacker', url: 'https://api.dicebear.com/7.x/avataaars/svg?seed=hacker&backgroundColor=000000&accessories=glasses', name: 'Hacker' },
    { id: 'captain', url: 'https://api.dicebear.com/7.x/avataaars/svg?seed=captain&backgroundColor=0066cc&hair=short', name: 'Starship Captain' }
  ];

  // Global variables
  let selectedAvatarUrl = '';
  let isAvatarModalOpen = false;

  // Enhanced security check
  document.addEventListener('DOMContentLoaded', function() {
    if (!localStorage.getItem("uid")) {
      window.location.href = "login.html";
      return;
    }
    
    createStarfield();
    initializeUserInfo();
    setupEventListeners();
    
    // Load saved theme
    const savedTheme = localStorage.getItem('theme') || 'light';
    document.body.dataset.theme = savedTheme;
    
    // Add welcome message
    setTimeout(() => {
      const messagesDiv = document.getElementById('messages');
      const loadingDiv = messagesDiv.querySelector('.loading');
      if (loadingDiv) {
        loadingDiv.remove();
      }
      
      const userName = localStorage.getItem('userName') || 
                      localStorage.getItem('userEmail')?.split('@')[0] || 
                      'Pilot';
      
      addSystemMessage(`Welcome to Galactic Chat, ${userName}! May the Force be with you.`);
      addSystemMessage('This is a demo chat. Messages are stored locally.');
      addSystemMessage('Try changing your avatar by clicking on your profile picture!');
    }, 1500);
  });

  // Initialize user information
  function initializeUserInfo() {
    const userName = localStorage.getItem('userName') || 
                    localStorage.getItem('userEmail')?.split('@')[0] || 
                    'Pilot';
    const userAvatar = localStorage.getItem('userAvatar') || 
                      `https://api.dicebear.com/7.x/avataaars/svg?seed=${localStorage.getItem('uid')}`;
    
    document.getElementById('userName').textContent = userName;
    document.getElementById('userAvatar').src = userAvatar;
    selectedAvatarUrl = userAvatar;
    
    // Set random online count
    const onlineCount = Math.floor(Math.random() * 50) + 10;
    document.getElementById('onlineCount').textContent = `${onlineCount} pilots online`;
  }

  // Setup event listeners
  function setupEventListeners() {
    // Enter key for sending messages
    document.getElementById('msg').addEventListener('keypress', function(e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });
    
    // Auto-resize textarea
    document.getElementById('msg').addEventListener('input', function() {
      autoResize(this);
    });
    
    // Typing indicator
    let typingTimer;
    document.getElementById('msg').addEventListener('input', function() {
      clearTimeout(typingTimer);
      // Simulate someone else typing
      if (Math.random() > 0.7) {
        const names = ['Luke', 'Leia', 'Han', 'Darth Vader', 'Yoda', 'Obi-Wan'];
        const randomName = names[Math.floor(Math.random() * names.length)];
        showTypingIndicator(randomName);
      }
      typingTimer = setTimeout(() => {
        document.getElementById('typingIndicator').style.display = 'none';
      }, 3000);
    });
  }

  // Auto-resize textarea
  function autoResize(textarea) {
    textarea.style.height = 'auto';
    textarea.style.height = Math.min(textarea.scrollHeight, 150) + 'px';
  }

  // Switch theme
  function switchSide(side) {
    if (document.body.dataset.theme === side) return;
    
    // Animation effect
    document.body.style.opacity = '0.7';
    
    setTimeout(() => {
      document.body.dataset.theme = side;
      localStorage.setItem('theme', side);
      document.body.style.opacity = '1';
      
      showNotification(`Switched to ${side === 'light' ? 'JEDI' : 'SITH'} theme`, 2000);
    }, 300);
  }

  // Logout function
  function logout() {
    if (confirm("Are you sure you want to leave the Galactic Chat Network?")) {
      document.body.style.opacity = '0.7';
      
      // Clear user data
      const itemsToRemove = [
        'uid', 'userEmail', 'userName', 'userAvatar', 
        'isDemo', 'theme', 'demoMessages'
      ];
      
      itemsToRemove.forEach(item => localStorage.removeItem(item));
      
      setTimeout(() => {
        window.location.href = "login.html";
      }, 500);
    }
  }

  // Send message
  function sendMessage() {
    const messageInput = document.getElementById('msg');
    const message = messageInput.value.trim();
    
    if (!message) return;
    
    // Get user info
    const userName = localStorage.getItem('userName') || 'Pilot';
    const userAvatar = localStorage.getItem('userAvatar') || 
                      `https://api.dicebear.com/7.x/avataaars/svg?seed=user`;
    
    // Create message element
    const messageDiv = document.createElement('div');
    messageDiv.className = 'message own';
    messageDiv.innerHTML = `
      <div class="text">${escapeHtml(message)}</div>
      <div class="time">${new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</div>
    `;
    
    document.getElementById('messages').appendChild(messageDiv);
    messageInput.value = '';
    autoResize(messageInput);
    scrollToBottom();
    
    // Store in local demo messages
    if (localStorage.getItem('isDemo')) {
      const demoMessages = JSON.parse(localStorage.getItem('demoMessages') || '[]');
      demoMessages.push({
        type: 'user',
        text: message,
        userName: userName,
        userAvatar: userAvatar,
        timestamp: new Date().toISOString()
      });
      localStorage.setItem('demoMessages', JSON.stringify(demoMessages));
    }
    
    // Simulate response after delay
    setTimeout(() => {
      simulateResponse();
    }, 1000 + Math.random() * 2000);
  }

  // Simulate chat responses
  function simulateResponse() {
    const responses = [
      "Roger that! The force is strong with this one.",
      "Copy that, pilot! Maintaining position.",
      "Affirmative. May the Force be with you.",
      "I've got a bad feeling about this...",
      "These aren't the droids you're looking for.",
      "Never tell me the odds!",
      "Do or do not. There is no try.",
      "I am your father... wait, wrong conversation!",
      "The dark side clouds everything.",
      "Help me Obi-Wan Kenobi, you're my only hope!"
    ];
    
    const names = ['Luke', 'Leia', 'Han', 'Darth Vader', 'Yoda', 'Obi-Wan', 'R2-D2', 'C-3PO'];
    const randomName = names[Math.floor(Math.random() * names.length)];
    const randomResponse = responses[Math.floor(Math.random() * responses.length)];
    
    const messageDiv = document.createElement('div');
    messageDiv.className = 'message';
    messageDiv.innerHTML = `
      <div class="message-header">
        <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=${randomName}" class="message-avatar" alt="${randomName}">
        <div class="sender">${randomName}</div>
      </div>
      <div class="text">${randomResponse}</div>
      <div class="time">${new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</div>
    `;
    
    document.getElementById('messages').appendChild(messageDiv);
    scrollToBottom();
  }

  // Show typing indicator
  function showTypingIndicator(userName) {
    const indicator = document.getElementById('typingIndicator');
    const typingUser = document.getElementById('typingUser');
    
    typingUser.textContent = `${userName} is typing...`;
    indicator.style.display = 'flex';
    
    clearTimeout(window.typingTimeout);
    window.typingTimeout = setTimeout(() => {
      indicator.style.display = 'none';
    }, 3000);
  }

  // Add system message
  function addSystemMessage(text) {
    const messagesDiv = document.getElementById('messages');
    
    const messageDiv = document.createElement('div');
    messageDiv.className = 'message system';
    messageDiv.innerHTML = `
      <div class="text">${text}</div>
      <div class="time">${new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</div>
    `;
    
    messagesDiv.appendChild(messageDiv);
    scrollToBottom();
  }

  // Scroll to bottom
  function scrollToBottom() {
    const messagesDiv = document.getElementById('messages');
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  }

  // Show notification
  function showNotification(message, duration = 3000) {
    const notification = document.getElementById('notification');
    notification.textContent = message;
    notification.style.display = 'block';
    notification.style.background = `linear-gradient(135deg, ${document.body.dataset.theme === 'light' ? '#00aaff' : '#ff0000'}, ${document.body.dataset.theme === 'light' ? '#0066cc' : '#cc0000'})`;
    
    setTimeout(() => {
      notification.style.display = 'none';
    }, duration);
  }

  // Escape HTML for security
  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  // Avatar modal functions
  function openAvatarModal() {
    isAvatarModalOpen = true;
    const modal = document.getElementById('avatarModal');
    const optionsDiv = document.getElementById('avatarOptions');
    
    // Load avatars
    optionsDiv.innerHTML = '';
    AVATAR_GALLERY.forEach(avatar => {
      const img = document.createElement('img');
      img.className = 'avatar-option';
      img.src = avatar.url;
      img.alt = avatar.name;
      img.title = avatar.name;
      img.dataset.url = avatar.url;
      
      if (avatar.url === selectedAvatarUrl) {
        img.classList.add('selected');
      }
      
      img.addEventListener('click', () => {
        document.querySelectorAll('.avatar-option').forEach(el => {
          el.classList.remove('selected');
        });
        img.classList.add('selected');
        selectedAvatarUrl = avatar.url;
        document.getElementById('userAvatar').src = avatar.url;
      });
      
      optionsDiv.appendChild(img);
    });
    
    modal.style.display = 'flex';
    document.getElementById('customAvatarUrl').value = '';
  }

  function closeAvatarModal() {
    isAvatarModalOpen = false;
    document.getElementById('avatarModal').style.display = 'none';
    // Restore original avatar
    document.getElementById('userAvatar').src = localStorage.getItem('userAvatar') || 
                                               `https://api.dicebear.com/7.x/avataaars/svg?seed=${localStorage.getItem('uid')}`;
  }

  function useCustomAvatar() {
    const urlInput = document.getElementById('customAvatarUrl');
    const url = urlInput.value.trim();
    
    if (url && isValidImageUrl(url)) {
      selectedAvatarUrl = url;
      document.getElementById('userAvatar').src = url;
      showNotification('Custom avatar loaded!');
    } else {
      showNotification('Please enter a valid image URL (jpg, png, gif, svg)', 4000);
    }
  }

  function saveAvatar() {
    if (selectedAvatarUrl) {
      localStorage.setItem('userAvatar', selectedAvatarUrl);
      document.getElementById('userAvatar').src = selectedAvatarUrl;
      showNotification('Avatar saved successfully!');
      closeAvatarModal();
      
      // Add system message about avatar change
      const userName = localStorage.getItem('userName') || 'Pilot';
      addSystemMessage(`${userName} has changed their avatar.`);
    }
  }

  function isValidImageUrl(url) {
    const pattern = /^https?:\/\/.+\.(jpg|jpeg|png|gif|svg|webp)(\?.*)?$/i;
    return pattern.test(url) || url.includes('dicebear.com');
  }

  // Make functions globally available
  window.switchSide = switchSide;
  window.logout = logout;
  window.sendMessage = sendMessage;
  window.showTypingIndicator = showTypingIndicator;
  window.addSystemMessage = addSystemMessage;
  window.scrollToBottom = scrollToBottom;
  window.showNotification = showNotification;
  window.openAvatarModal = openAvatarModal;
  window.closeAvatarModal = closeAvatarModal;
  window.useCustomAvatar = useCustomAvatar;
  window.saveAvatar = saveAvatar;
  window.autoResize = autoResize;
</script>

<script type="module" src="./js/chat.js"></script>
</body>
</html>
